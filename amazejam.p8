pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
--cos1 = cos function cos(angle) return cos1(angle/(3.1415*2)) end
--sin1 = sin function sin(angle) return sin1(-angle/(3.1415*2)) end

function _init()
  base_seed=flr(rnd(100000))
  level=0
  maxlevel=10
  player = {x=0, y=64}
  t=0
  moving=0

  pond_t=0
  pond={}
  
  refurbish()  
end

function _update()
  t=t+1
  local m = false
  if btn(1) then
    player.x = player.x + 1
    if moving==0 then t=0 end
    m = true
    if player.x >= 120 then
    	 level = level+1
    	 player.x=0
    	 refurbish()
    end
  elseif btn(0) then
    player.x = player.x-1
    m = true
    if moving==0 then t=0 end
    if player.x<=0 and level>0 then
      level=level-1
      player.x=120
      refurbish()
    end
  end
  if m then moving = 10 - (t % 10) end
	 if moving > 0 then
    player.y=64-flr(abs(sin(t*0.05)*12))
    moving = moving - 1
  else
    player.y = 64
  end
  
  pond_t=pond_t+1
  for c in all(pond) do
    c.r=c.r+1
    if c.r>128+32 then del(pond,c) end
  end
  if flr(rnd(80))==0 then
    add(pond, {
      x=160,
      y=106,
      r=1
    })
  end
end

function refurbish()
  srand(level+base_seed)
  herbs = permute(16,rnd(4)+2)
  stars={}
  for i=0,6+rnd(30) do
    add(stars,{flr(rnd(128)),flr(rnd(64))})
  end
  moon={flr(rnd(128-32)+16),flr(rnd(32)-16),flr(rnd(16)+24)}
  trees={}
  for i=0,flr(rnd(6)) do
    add(trees, {
      x=flr(rnd(112)),
      t={},
      b=flr(rnd(3))
    })
    local l=flr(rnd(3)+1)      
    for ii=1,l do
      add(trees[#trees].t, flr(rnd(3)))
    end
  end
end

function _draw()
  cls()
  
  -- floor
  for i=0,15 do
    spr(17, i*8, 72)
  end
  
  -- moon
  if level>1 then
    circfill(moon[1],moon[3],16,7)
    circfill(moon[1]+moon[2],moon[3],16,0)
  end
  
  -- stars
  if level>0 then
    for star in all(stars) do
      pset(star[1],star[2],7)
    end
  end
  
  -- player
  spr(1,player.x,player.y)
  
  -- trees
  if level>2 then
    for tree in all(trees) do
      for l=1,#tree.t do
        spr(tree.t[l]+3,tree.x,72-8*l)
        spr(tree.t[l]+19,tree.x+8,72-8*l)
      end
      spr(tree.b*2+22,tree.x,64-8*#tree.t)
      spr(tree.b*2+23,tree.x+8,64-8*#tree.t)
      spr(tree.b*2+6,tree.x,56-8*#tree.t)
      spr(tree.b*2+7,tree.x+8,56-8*#tree.t)
    end
  end
  
  -- herbs
  for i in all(herbs) do
    spr(16, i*8, 64)
  end
  
  -- title
  if level == 5 then
    print("the road to dreams", 32, 96)
  end
  
  -- pond
  if level>3 then
    clip(0,80,128,48)
    for c in all(pond) do
      circ(c.x,c.y,c.r,1)
    end
    clip()
  end
end

function permute(n,m)
  m = m or n
  m = min(m,n)
  local ret={}
  local pool={}
  for i=1,n do
    add(pool, i)
  end
  for i=1,m do
    local v = pool[flr(rnd(#pool)) + 1]
    add(ret, v)
    del(pool, v)
  end
  return ret
end
__gfx__
00000000000990000000000000000044000000040000000400003333333300000000000000000000000000000000000000000000000000000000000000000000
00000000000990000000000000000044000000040000000400333383333333000000000000000000000000000000000000000000000000000000000000000000
00700700033333300000000000000044000000040000000403333333333333300000000000000000000000000000000000000000000000000000000000000000
00077000303333030000000000000044000000040000044403333333383333300000000000000000000000000000000000000000000000000000000000000000
0007700030eeee030000000000004444000000440000000433333333333333330000000000000000000000000000000000000000000000000000000000000000
0070070030e00e030000000000000444000000440000000433338333333333330000400400000000000000000000000000000000000000000000000000000000
0000000000e00e000000000000000044000000040000000438333333333338330000044000000000000000000000000000000000000000000000000000000000
0000000000e00e00000000000000004400000004000000043333333333333333000000400000000000000000e000000000000000000000000000000000000000
00000000bbbbbbbb0000000040000000440000004400000033333333333333380000004000000000000030033000003000000000000000000000000000000000
00000000bbbbbbbb0000000040400000444000004444400033333333383333330004004000400400000040344433040000000000000000000000000000000000
0000000044b44b4b000000004040000044400000440000003833333333333333000040400040400000034040004440e000000000000000000000000000000000
0000000044444b440000000044000000440000004400000033333333333333330000044400040000000e04300004300000000000000000000000000000000000
00000000444444440000000044000000440000004400000003333333333383300000000400400000003003400340000000000000000000000000000000000000
00000000444444440000000044000000440000004400000003333833333333300044000404004400004400430400443000000000000000000000000000000000
00000b00444444440000000044000000440000004440000000333333383333000000440444440000000344434444000000000000000000000000000000000000
b0b00b00444444440000000044000000440000004400000000003333333300000000004444000000000003044433000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000001000100000100000100000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000100001a05000000000001b0501b050000001b0500000000000000000000000000240500000000000210500000000000000001d050000000000000000000000000022050000000000000000000000000000000
00020000220501e0501a050140500f050090500405006050080500c05011050160501f050270502b0502a050234002a40033400124000b000090000f000150001a0001d0001f0001f0001e0001f0002000026000
__music__
00 01020344

